---
import type { TourEventsAPIResponse } from '@/types/bandsintown';

interface Props {
  limit?: number;
}

const { limit } = Astro.props;

// Fetch events from our API endpoint
let events: TourEventsAPIResponse['data'] = [];
let error: string | null = null;

try {
  const apiUrl = new URL('/api/events', Astro.url.origin);
  apiUrl.searchParams.set('date', 'upcoming');

  const response = await fetch(apiUrl.toString());
  const data: TourEventsAPIResponse = await response.json();

  if (data.success && data.data) {
    events = limit ? data.data.slice(0, limit) : data.data;
  } else {
    error = data.error || 'Failed to load events';
  }
} catch (err) {
  console.error('Error fetching events:', err);
  error = 'Failed to load tour dates';
}
---

<section class='w-full flex flex-col gap-4'>
  <h2 class='text-2xl font-bold text-white bg-black/80 border border-white p-4 text-center'>Tour Dates</h2>

  {error && (
    <div class='bg-red-900/50 border border-red-500 text-white p-4 rounded'>
      {error}
    </div>
  )}

  {!error && events && events.length === 0 && (
    <div class='bg-gray-800 text-white p-4 rounded'>
      No upcoming tour dates scheduled.
    </div>
  )}

  {events && events.length > 0 && (
    <div class='flex flex-col gap-3'>
      {events.map((event) => (
        <div
          class='bg-black/80 border border-white text-white p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2'
        >
          <div class='flex flex-col'>
            <span class='font-bold'>{event.date}</span>
            <span class='text-sm'>
              {event.venue} - {event.city}, {event.country}
            </span>
          </div>

          <div class='flex gap-2'>
            <a
              href={event.eventUrl}
              target='_blank'
              rel='noopener noreferrer'
              class='bg-white text-black px-4 py-2 hover:bg-gray-300 transition-colors text-sm'
            >
              Details
            </a>
            {event.ticketUrl && (
              <a
                href={event.ticketUrl}
                target='_blank'
                rel='noopener noreferrer'
                class='bg-red-700 text-white px-4 py-2 hover:bg-red-600 transition-colors text-sm'
              >
                Tickets
              </a>
            )}
          </div>
        </div>
      ))}
    </div>
  )}
</section>
