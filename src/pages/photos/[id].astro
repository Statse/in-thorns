---
import Layout from '@/layouts/Layout.astro'
import { readdirSync } from 'fs'
import { join } from 'path'

const { id } = Astro.params

// Read images from public/photos/exit_wounds directory
const photosDir = join(process.cwd(), 'public', 'photos', 'exit_wounds')
const imageFiles = readdirSync(photosDir)
	.filter((file) => file.endsWith('.webp'))
	.sort((a, b) => {
		// Extract numbers from filenames for proper numeric sorting
		const numA = parseInt(a.match(/\d+/)?.[0] || '0')
		const numB = parseInt(b.match(/\d+/)?.[0] || '0')
		return numA - numB
	})

// Build photos map dynamically
const photos: Record<string, { src: string; alt: string }> = {}
imageFiles.forEach((file, index) => {
	photos[String(index + 1)] = {
		src: `/photos/exit_wounds/${file}`,
		alt: 'In Thorns - Exit Wounds'
	}
})

const photo = photos[id as keyof typeof photos]

// If photo not found, redirect to home
if (!photo) {
	return Astro.redirect('/#photos')
}

// Calculate prev/next with looping
const currentId = parseInt(id as string)
const totalPhotos = Object.keys(photos).length
const prevId = currentId === 1 ? totalPhotos : currentId - 1
const nextId = currentId === totalPhotos ? 1 : currentId + 1
---

<Layout title='In Thorns - Photos'>
	<main class='min-h-screen w-full bg-black flex items-center justify-center p-4 relative'>
		<!-- Close Button -->
		<a
			href='/#photos'
			class='fixed top-6 right-6 z-50 w-12 h-12 flex items-center justify-center bg-ew-orange/20 border-2 border-ew-orange hover:bg-ew-orange hover:border-ew-orange-light transition-all group cursor-pointer'
			aria-label='Close and return to gallery'
		>
			<svg class='w-6 h-6 text-ew-orange group-hover:text-black transition-colors' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path>
			</svg>
		</a>

		<!-- Previous Photo Button -->
		<a
			href={`/photos/${prevId}`}
			class='fixed left-6 top-1/2 -translate-y-1/2 z-50 w-12 h-12 flex items-center justify-center bg-ew-green/20 border-2 border-ew-green hover:bg-ew-green hover:border-ew-green-light transition-all group cursor-pointer'
			aria-label='Previous photo'
		>
			<svg class='w-6 h-6 text-ew-green group-hover:text-black transition-colors' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7'></path>
			</svg>
		</a>

		<!-- Next Photo Button -->
		<a
			href={`/photos/${nextId}`}
			class='fixed right-6 top-1/2 -translate-y-1/2 z-50 w-12 h-12 flex items-center justify-center bg-ew-green/20 border-2 border-ew-green hover:bg-ew-green hover:border-ew-green-light transition-all group cursor-pointer'
			aria-label='Next photo'
		>
			<svg class='w-6 h-6 text-ew-green group-hover:text-black transition-colors' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5l7 7-7 7'></path>
			</svg>
		</a>

		<!-- Image Container -->
		<div class='w-full h-full max-w-7xl max-h-screen flex items-center justify-center'>
			<img
				src={photo.src}
				alt={photo.alt}
				class='max-w-full max-h-[90vh] object-contain'
				transition:name={`photo-${id}`}
			/>
		</div>

		<!-- Image info overlay -->
		<div class='fixed bottom-6 left-1/2 -translate-x-1/2 bg-black/80 backdrop-blur-sm border-2 border-ew-orange/30 px-6 py-3 z-50'>
			<p class='text-ew-cream text-sm'>{photo.alt}</p>
		</div>
	</main>
</Layout>
