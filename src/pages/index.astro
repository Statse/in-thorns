---
import Layout from '@/layouts/Layout.astro'
import Navigation from '@/components/navigation/navigation.astro'
import Hero from '@/components/hero/hero.astro'
import Music from '@/components/music/music.astro'
import Tour from '@/components/tour/tour.astro'
import Photos from '@/components/photos/photos.astro'
import About from '@/components/about/about.astro'
import Contact from '@/components/contact/contact.astro'
---

<Layout title="In Thorns - Let's Sail into the Unknown">
	<div class='scroll-smooth'>
		<Navigation />

		<Hero />

		<!-- Barcode Divider -->
		<div class='h-1 bg-gradient-to-r from-transparent via-ew-orange to-transparent'></div>
		<div class='h-px bg-ew-green'></div>

		<Music />

		<!-- Barcode Divider -->
		<div class='h-1 bg-gradient-to-r from-transparent via-ew-green to-transparent'></div>

		<Tour />

		<!-- Barcode Divider -->
		<div class='h-1 bg-gradient-to-r from-transparent via-ew-orange to-transparent'></div>

		<Photos />

		<!-- Barcode Divider -->
		<div class='h-1 bg-gradient-to-r from-transparent via-ew-green to-transparent'></div>

		<About />

		<Contact />
	</div>
</Layout>

<style>
	html {
		scroll-behavior: smooth;
		overflow-x: hidden;
	}

	body {
		overflow-x: hidden;
	}

	/* Film grain effect */
	@keyframes grain {
		0%, 100% { transform: translate(0, 0); }
		10% { transform: translate(-5%, -10%); }
		30% { transform: translate(3%, -15%); }
		50% { transform: translate(12%, 9%); }
		70% { transform: translate(9%, -1%); }
		90% { transform: translate(-1%, 7%); }
	}
</style>

<script>
	// Prevent auto-scroll on page load
	if ('scrollRestoration' in history) {
		history.scrollRestoration = 'manual';
	}

	// Store scroll position when clicking a photo
	document.addEventListener('astro:page-load', () => {
		// Re-attach listeners after view transition
		attachPhotoClickListeners();
		attachHashScrollListeners();

		// Restore scroll position ONLY if coming back from photo viewer
		const savedScroll = sessionStorage.getItem('galleryScrollPosition');
		if (savedScroll && window.location.pathname === '/') {
			// Restore to saved position instantly (no smooth scroll)
			setTimeout(() => {
				window.scrollTo({
					top: parseInt(savedScroll),
					left: 0,
					behavior: 'instant'
				});
			}, 0);
			sessionStorage.removeItem('galleryScrollPosition');
		} else if (window.location.pathname === '/' && !window.location.hash) {
			// Fresh page load - ensure we're at the top
			window.scrollTo(0, 0);
		} else if (window.location.hash) {
			// Handle hash scroll if present and no saved position
			setTimeout(() => {
				const target = document.querySelector(window.location.hash);
				if (target) {
					target.scrollIntoView({
						behavior: 'instant',
						block: 'start'
					});
				}
			}, 0);
		}
	});

	function attachPhotoClickListeners() {
		document.querySelectorAll('a[href^="/photos/"]').forEach(link => {
			link.addEventListener('click', () => {
				// Save current scroll position before navigating to photo
				sessionStorage.setItem('galleryScrollPosition', window.scrollY.toString());
			});
		});
	}

	function attachHashScrollListeners() {
		// Smooth scroll behavior for anchor links
		document.querySelectorAll('a[href^="#"]').forEach(anchor => {
			anchor.addEventListener('click', function (e) {
				e.preventDefault();
				//@ts-ignore
				const target = document.querySelector(this.getAttribute('href'));
				if (target) {
					target.scrollIntoView({
						behavior: 'smooth',
						block: 'start'
					});
				}
			});
		});
	}

	// Initial attachment
	attachPhotoClickListeners();
	attachHashScrollListeners();

	// Add black background to nav after scrolling past hero
	const mainNav = document.getElementById('main-nav') as HTMLElement;
	const heroSection = document.getElementById('hero') as HTMLElement;
	const heroLogo = document.getElementById('hero-logo') as HTMLElement;
	const navLogo = document.getElementById('nav-logo') as HTMLElement;

	// Add active state to nav links on scroll + handle nav background
	const sections = document.querySelectorAll('section[id]') as NodeListOf<HTMLElement>;
	const navLinks = document.querySelectorAll('nav a[href^="#"]');

	window.addEventListener('scroll', () => {
		const scrollPosition = window.pageYOffset;
		const heroHeight = heroSection.offsetHeight;

		// Logo animation threshold (halfway through hero section)
		const logoThreshold = heroHeight * 0.5;

		// Animate logo transition
		if (scrollPosition > logoThreshold) {
			// Fade out hero logo, fade in nav logo
			heroLogo.style.opacity = '0';
			heroLogo.style.transform = 'scale(0.3) translateY(-300px)';
			navLogo.style.opacity = '1';
		} else {
			// Reset to original state
			heroLogo.style.opacity = '1';
			heroLogo.style.transform = 'scale(1) translateY(0)';
			navLogo.style.opacity = '0';
		}

		// Add black background after scrolling past hero
		if (scrollPosition > heroHeight - 100) {
			mainNav.classList.add('bg-black/90', 'backdrop-blur-sm', 'border-b', 'border-ew-orange/30');
		} else {
			mainNav.classList.remove('bg-black/90', 'backdrop-blur-sm', 'border-b', 'border-ew-orange/30');
		}

		// Update active nav link
		let current = '';
		sections.forEach(section => {
			const sectionTop = section.offsetTop;
			const sectionHeight = section.clientHeight;
			if (scrollPosition >= sectionTop - 200) {
				current = section.getAttribute('id') as string;
			}
		});

		navLinks.forEach(link => {
			link.classList.remove('text-ew-orange');
			if (link.getAttribute('href') === `#${current}`) {
				link.classList.add('text-ew-orange');
			}
		});
	});
</script>
